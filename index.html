<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Group - Number Picker</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 20px;
        }
        .container { text-align: center; max-width: 800px; width: 100%; animation: fadeIn 0.8s ease-out; }
        h1 { color: white; font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .subtitle { color: rgba(255, 255, 255, 0.9); font-size: 1.2rem; margin-bottom: 30px; }
        
        .participants-control { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .control-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; border: none; width: 50px; height: 50px; border-radius: 50%;
            font-size: 2rem; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-weight: bold;
        }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .participants-info { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: 15px 30px; border-radius: 15px; text-align: center; min-width: 120px; }
        .participants-count { font-size: 3rem; font-weight: bold; color: white; line-height: 1; }
        .amount { color: #ffd700; font-weight: bold; font-size: 1.2rem; margin-bottom: 30px; }
        
        .cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 0 auto 30px; max-width: 700px; }
        .card { perspective: 1000px; height: 200px; cursor: pointer; }
        .card.picked { cursor: not-allowed; opacity: 0.7; }
        .card.user-picked .card-inner { border: 4px solid #ffd700 !important; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
        
        .card-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .card-front { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: 3px solid rgba(255,255,255,0.3); }
        .card-front::before { content: '?'; font-size: 4rem; color: white; font-weight: bold; }
        .card-back { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border: 3px solid rgba(255,255,255,0.5); transform: rotateY(180deg); }
        .card-number { font-size: 5rem; font-weight: bold; color: white; }
        
        .status-msg {
            color: white; margin-bottom: 10px; font-weight: 500; font-size: 1rem;
            background: rgba(0, 0, 0, 0.2); padding: 5px 15px; border-radius: 20px;
            display: inline-block; min-height: 1.5rem;
        }

        .reset-btn { 
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
            color: white; border: none; padding: 15px 40px; font-size: 1.1rem; 
            border-radius: 50px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .reset-btn:disabled {
            background: #cccccc; color: #666666;
            cursor: not-allowed; box-shadow: none; opacity: 0.7;
        }
        
        @keyframes fadeOut { to { opacity: 0; transform: scale(0.5) translateY(-20px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="celebrate" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000;"></div>
    <div class="container">
        <h1>üí∞ Savings Group Number Picker</h1>
        <p class="subtitle">Pick a card! Selection is locked to your browser ID.</p>
        <div id="userStatus" style="display: none; background: rgba(255, 215, 0, 0.2); padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; color: #ffd700; font-weight: bold;">‚≠ê You've already picked!</div>
        
        <div class="participants-control">
            <button class="control-btn" id="minusBtn" onclick="adjustParticipants(-1)">‚àí</button>
            <div class="participants-info"><div class="participants-count" id="participantsCount">4</div><div>Participants</div></div>
            <button class="control-btn" id="plusBtn" onclick="adjustParticipants(1)">+</button>
        </div>
        
        <p class="amount" id="amountDisplay"></p>
        <div class="cards-container" id="cardsContainer"></div>
        
        <div>
            <div id="statusMsg" class="status-msg">Loading...</div><br>
            <button class="reset-btn" id="resetBtn" onclick="resetCards()">üîÑ Reset & Shuffle</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCakbDdob_0u1tPQJkRNMjdEEWoYHwvdOU",
            authDomain: "billionaire-gang-ajo.firebaseapp.com",
            databaseURL: "https://billionaire-gang-ajo-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "billionaire-gang-ajo",
            storageBucket: "billionaire-gang-ajo.firebasestorage.app",
            messagingSenderId: "327004000449",
            appId: "1:327004000449:web:dc768f5e6f2e28c0460440",
            measurementId: "G-8Y37G91ZQW"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const sessionId = 'savings-session-' + new Date().toISOString().split('T')[0];
        const sessionRef = db.ref(sessionId);

        let browserId = localStorage.getItem('ajo_browser_id');
        if (!browserId) {
            browserId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('ajo_browser_id', browserId);
        }

        let lastResetTime = 0;
        let isAnimating = false;

        function initializeSession() {
            sessionRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) { createNewShuffle(); return; }

                if (data.lastReset && data.lastReset > lastResetTime) {
                    lastResetTime = data.lastReset;
                    handleRemoteReset(data);
                } else if (!isAnimating) {
                    syncUI(data);
                }
            });
        }

        function handleRemoteReset(data) {
            isAnimating = true;
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.textContent = "‚ôªÔ∏è Shuffling cards...";
            
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, i) => { setTimeout(() => { card.style.animation = 'fadeOut 0.4s forwards'; }, i * 50); });
            setTimeout(() => { 
                document.getElementById('cardsContainer').innerHTML = ''; 
                isAnimating = false; 
                syncUI(data); 
            }, (cards.length * 50) + 500);
        }

        function syncUI(data) {
            const pickedByData = data.pickedBy || {};
            const pickedCards = data.pickedCards || {};
            const numbers = data.numbers || [];
            const totalParticipants = data.participantCount;
            const pickedCount = Object.keys(pickedCards).length;
            
            const resetBtn = document.getElementById('resetBtn');
            const plusBtn = document.getElementById('plusBtn');
            const minusBtn = document.getElementById('minusBtn');
            const statusMsg = document.getElementById('statusMsg');
            
            // STATUS LOGIC
            if (pickedCount === 0) {
                statusMsg.textContent = "‚úÖ Ready to start!";
                resetBtn.disabled = false;
                plusBtn.disabled = false;
                minusBtn.disabled = false;
            } else if (pickedCount < totalParticipants) {
                statusMsg.textContent = `‚è≥ ${pickedCount}/${totalParticipants} picked. Shuffle locked.`;
                resetBtn.disabled = true;
                plusBtn.disabled = true;
                minusBtn.disabled = true;
            } else {
                statusMsg.textContent = "üéâ All done! You can reset for a new round.";
                resetBtn.disabled = false;
                plusBtn.disabled = false;
                minusBtn.disabled = false;
            }

            let myPickedIndex = null;
            Object.keys(pickedByData).forEach(idx => {
                if (pickedByData[idx] === browserId) myPickedIndex = idx;
            });

            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            numbers.forEach((num, i) => {
                const card = document.createElement('div');
                card.className = 'card' + (pickedCards[i] ? ' flipped picked' : '');
                if (myPickedIndex == i) card.classList.add('user-picked');

                card.onclick = () => {
                    if (pickedCards[i]) return;
                    if (myPickedIndex !== null) {
                        alert("‚ö†Ô∏è You've already picked a card!");
                        return;
                    }
                    sessionRef.child('pickedCards').child(i).set(true);
                    sessionRef.child('pickedBy').child(i).set(browserId);
                };

                card.innerHTML = `<div class="card-inner"><div class="card-front"></div><div class="card-back"><div class="card-number">${num}</div></div></div>`;
                container.appendChild(card);
            });

            document.getElementById('userStatus').style.display = myPickedIndex !== null ? 'block' : 'none';
            document.getElementById('participantsCount').textContent = totalParticipants;
            document.getElementById('amountDisplay').textContent = `Total Pool: ‚Ç¶${(totalParticipants * 150000).toLocaleString()}`;
        }

        function createNewShuffle() {
            const count = parseInt(document.getElementById('participantsCount').textContent);
            const shuffled = Array.from({length: count}, (_, i) => i + 1).sort(() => Math.random() - 0.5);
            sessionRef.set({ numbers: shuffled, participantCount: count, pickedCards: {}, pickedBy: {}, lastReset: Date.now() });
        }

        function resetCards() { createNewShuffle(); }
        function adjustParticipants(val) { 
            let count = parseInt(document.getElementById('participantsCount').textContent);
            document.getElementById('participantsCount').textContent = Math.max(2, Math.min(20, count + val));
            resetCards(); 
        }

        window.onload = initializeSession;
    </script>
</body>
</html>